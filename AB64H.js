// ==UserScript==
// @name AB64H
// @description Auto BASE64 Hangouts
// @namespace AB64H
// @version 0.1
// @include https://mail.google.com
// @require http://code.jquery.com/jquery-git.min.js
// @license APACHE LICENSE 2.0
// @supportURL https://gitlab.com/jlxip/AB64H
// ==/UserScript==

// Más fuentes:
// JSAES v0.1 (compactado no oficialmente): http://point-at-infinity.org/jsaes/
function AES_Init(){AES_Sbox_Inv=  new Array(256);for(var i=0;i< 256;i++){AES_Sbox_Inv[AES_Sbox[i]]= i};AES_ShiftRowTab_Inv=  new Array(16);for(var i=0;i< 16;i++){AES_ShiftRowTab_Inv[AES_ShiftRowTab[i]]= i};AES_xtime=  new Array(256);for(var i=0;i< 128;i++){AES_xtime[i]= i<< 1;AES_xtime[128+ i]= (i<< 1)^ 0x1b}}function AES_Done(){delete AES_Sbox_Inv;delete AES_ShiftRowTab_Inv;delete AES_xtime}function AES_ExpandKey(key){var kl=key["length"],ks,Rcon=1;switch(kl){case 16:ks= 16* (10+ 1);break;case 24:ks= 16* (12+ 1);break;case 32:ks= 16* (14+ 1);break;default:alert("AES_ExpandKey: Only key lengths of 16, 24 or 32 bytes allowed!")};for(var i=kl;i< ks;i+= 4){var temp=key["slice"](i- 4,i);if(i% kl== 0){temp=  new Array(AES_Sbox[temp[1]]^ Rcon,AES_Sbox[temp[2]],AES_Sbox[temp[3]],AES_Sbox[temp[0]]);if((Rcon<<= 1)>= 256){Rcon^= 0x11b}}else {if((kl> 24)&& (i% kl== 16)){temp=  new Array(AES_Sbox[temp[0]],AES_Sbox[temp[1]],AES_Sbox[temp[2]],AES_Sbox[temp[3]])}};for(var j=0;j< 4;j++){key[i+ j]= key[i+ j- kl]^ temp[j]}}}function AES_Encrypt(block,key){var l=key["length"];AES_AddRoundKey(block,key["slice"](0,16));for(var i=16;i< l- 16;i+= 16){AES_SubBytes(block,AES_Sbox);AES_ShiftRows(block,AES_ShiftRowTab);AES_MixColumns(block);AES_AddRoundKey(block,key["slice"](i,i+ 16))};AES_SubBytes(block,AES_Sbox);AES_ShiftRows(block,AES_ShiftRowTab);AES_AddRoundKey(block,key["slice"](i,l))}function AES_Decrypt(block,key){var l=key["length"];AES_AddRoundKey(block,key["slice"](l- 16,l));AES_ShiftRows(block,AES_ShiftRowTab_Inv);AES_SubBytes(block,AES_Sbox_Inv);for(var i=l- 32;i>= 16;i-= 16){AES_AddRoundKey(block,key["slice"](i,i+ 16));AES_MixColumns_Inv(block);AES_ShiftRows(block,AES_ShiftRowTab_Inv);AES_SubBytes(block,AES_Sbox_Inv)};AES_AddRoundKey(block,key["slice"](0,16))}AES_Sbox=  new Array(99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22);AES_ShiftRowTab=  new Array(0,5,10,15,4,9,14,3,8,13,2,7,12,1,6,11);function AES_SubBytes(state,sbox){for(var i=0;i< 16;i++){state[i]= sbox[state[i]]}}function AES_AddRoundKey(state,rkey){for(var i=0;i< 16;i++){state[i]^= rkey[i]}}function AES_ShiftRows(state,shifttab){var h= new Array()["concat"](state);for(var i=0;i< 16;i++){state[i]= h[shifttab[i]]}}function AES_MixColumns(state){for(var i=0;i< 16;i+= 4){var s0=state[i+ 0],s1=state[i+ 1];var s2=state[i+ 2],s3=state[i+ 3];var h=s0^ s1^ s2^ s3;state[i+ 0]^= h^ AES_xtime[s0^ s1];state[i+ 1]^= h^ AES_xtime[s1^ s2];state[i+ 2]^= h^ AES_xtime[s2^ s3];state[i+ 3]^= h^ AES_xtime[s3^ s0]}}function AES_MixColumns_Inv(state){for(var i=0;i< 16;i+= 4){var s0=state[i+ 0],s1=state[i+ 1];var s2=state[i+ 2],s3=state[i+ 3];var h=s0^ s1^ s2^ s3;var xh=AES_xtime[h];var h1=AES_xtime[AES_xtime[xh^ s0^ s2]]^ h;var h2=AES_xtime[AES_xtime[xh^ s1^ s3]]^ h;state[i+ 0]^= h1^ AES_xtime[s0^ s1];state[i+ 1]^= h2^ AES_xtime[s1^ s2];state[i+ 2]^= h1^ AES_xtime[s2^ s3];state[i+ 3]^= h2^ AES_xtime[s3^ s0]}}
// Wrapper code by Osama Oransa (compactado): http://osama-oransa.blogspot.com.es/2012/03/using-aes-encrypting-in-java-script.html
function init(myKey){AES_Init();var key=string2Bin(myKey);AES_ExpandKey(key);return key}function encrypt(inputStr,key){var block=string2Bin(inputStr);AES_Encrypt(block,key);var data=bin2String(block);return data}function decrypt(inputStr,key){block= string2Bin(inputStr);AES_Decrypt(block,key);var data=bin2String(block);return data}function encryptLongString(myString,key){if(myString["length"]> 16){var data="";for(var i=0;i< myString["length"];i= i+ 16){data+= encrypt(myString["substr"](i,16),key)};return data}else {return encrypt(myString,key)}}function decryptLongString(myString,key){if(myString["length"]> 16){var data="";for(var i=0;i< myString["length"];i= i+ 16){data+= decrypt(myString["substr"](i,16),key)};return data}else {return decrypt(myString,key)}}function finish(){AES_Done()}function bin2String(array){var result="";for(var i=0;i< array["length"];i++){result+= String["fromCharCode"](parseInt(array[i],2))};return result}function string2Bin(str){var result=[];for(var i=0;i< str["length"];i++){result["push"](str["charCodeAt"](i))};return result}function bin2String(array){return String["fromCharCode"]["apply"](String,array)}
// MD5 JAVASCRIPT 3.24: http://www.desarrolloweb.com/articulos/ejemplos/php-js/md5.pack.js
eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('m 2b(v){e 1y;e S=m(J,1p){l(J<<1p)|(J>>>(32-1p))};e f=m(1e,1g){e 1m,1n,D,C,u;D=(1e&1x);C=(1g&1x);1m=(1e&1j);1n=(1g&1j);u=(1e&1G)+(1g&1G);r(1m&1n){l(u^1x^D^C)}r(1m|1n){r(u&1j){l(u^2c^D^C)}1o{l(u^1j^D^C)}}1o{l(u^D^C)}};e 1E=m(x,y,z){l(x&y)|((~x)&z)};e 1J=m(x,y,z){l(x&z)|(y&(~z))};e 1N=m(x,y,z){l(x^y^z)};e 1B=m(x,y,z){l(y^(x|(~z)))};e g=m(a,b,c,d,x,s,t){a=f(a,f(f(1E(b,c,d),x),t));l f(S(a,s),b)};e j=m(a,b,c,d,x,s,t){a=f(a,f(f(1J(b,c,d),x),t));l f(S(a,s),b)};e h=m(a,b,c,d,x,s,t){a=f(a,f(f(1N(b,c,d),x),t));l f(S(a,s),b)};e i=m(a,b,c,d,x,s,t){a=f(a,f(f(1B(b,c,d),x),t));l f(S(a,s),b)};e 1A=m(v){e B;e I=v.1k;e 1q=I+8;e 1M=(1q-(1q%1L))/1L;e 1h=(1M+1)*16;e q=2d 1Z(1h-1);e M=0;e o=0;28(o<I){B=(o-(o%4))/4;M=(o%4)*8;q[B]=(q[B]|(v.1F(o)<<M));o++}B=(o-(o%4))/4;M=(o%4)*8;q[B]=q[B]|(24<<M);q[1h-2]=I<<3;q[1h-1]=I>>>29;l q};e T=m(J){e 1f="",1d="",1w,K;1v(K=0;K<=3;K++){1w=(J>>>(K*8))&25;1d="0"+1w.26(16);1f=1f+1d.27(1d.1k-2,2)}l 1f};e x=[],k,1u,1r,1s,1t,a,b,c,d,1c=7,Q=12,L=17,N=22,R=5,E=9,W=14,Z=20,V=4,U=11,19=16,F=23,H=6,P=10,O=15,G=21;v=2e.1K(v);x=1A(v);a=2f;b=2m;c=2n;d=2o;1y=x.1k;1v(k=0;k<1y;k+=16){1u=a;1r=b;1s=c;1t=d;a=g(a,b,c,d,x[k+0],1c,2l);d=g(d,a,b,c,x[k+1],Q,2k);c=g(c,d,a,b,x[k+2],L,2g);b=g(b,c,d,a,x[k+3],N,2h);a=g(a,b,c,d,x[k+4],1c,2i);d=g(d,a,b,c,x[k+5],Q,2j);c=g(c,d,a,b,x[k+6],L,2p);b=g(b,c,d,a,x[k+7],N,1U);a=g(a,b,c,d,x[k+8],1c,1R);d=g(d,a,b,c,x[k+9],Q,1Q);c=g(c,d,a,b,x[k+10],L,1O);b=g(b,c,d,a,x[k+11],N,1P);a=g(a,b,c,d,x[k+12],1c,1W);d=g(d,a,b,c,x[k+13],Q,1X);c=g(c,d,a,b,x[k+14],L,1S);b=g(b,c,d,a,x[k+15],N,1T);a=j(a,b,c,d,x[k+1],R,1V);d=j(d,a,b,c,x[k+6],E,1Y);c=j(c,d,a,b,x[k+11],W,2a);b=j(b,c,d,a,x[k+0],Z,2r);a=j(a,b,c,d,x[k+5],R,30);d=j(d,a,b,c,x[k+10],E,2Z);c=j(c,d,a,b,x[k+15],W,31);b=j(b,c,d,a,x[k+4],Z,33);a=j(a,b,c,d,x[k+9],R,35);d=j(d,a,b,c,x[k+14],E,34);c=j(c,d,a,b,x[k+3],W,2Y);b=j(b,c,d,a,x[k+8],Z,2X);a=j(a,b,c,d,x[k+13],R,2S);d=j(d,a,b,c,x[k+2],E,37);c=j(c,d,a,b,x[k+7],W,2R);b=j(b,c,d,a,x[k+12],Z,2q);a=h(a,b,c,d,x[k+5],V,2T);d=h(d,a,b,c,x[k+8],U,2U);c=h(c,d,a,b,x[k+11],19,2W);b=h(b,c,d,a,x[k+14],F,2V);a=h(a,b,c,d,x[k+1],V,36);d=h(d,a,b,c,x[k+4],U,3d);c=h(c,d,a,b,x[k+7],19,3e);b=h(b,c,d,a,x[k+10],F,3b);a=h(a,b,c,d,x[k+13],V,3a);d=h(d,a,b,c,x[k+0],U,39);c=h(c,d,a,b,x[k+3],19,3c);b=h(b,c,d,a,x[k+6],F,38);a=h(a,b,c,d,x[k+9],V,2P);d=h(d,a,b,c,x[k+12],U,2y);c=h(c,d,a,b,x[k+15],19,2z);b=h(b,c,d,a,x[k+2],F,2A);a=i(a,b,c,d,x[k+0],H,2B);d=i(d,a,b,c,x[k+7],P,2x);c=i(c,d,a,b,x[k+14],O,2w);b=i(b,c,d,a,x[k+5],G,2s);a=i(a,b,c,d,x[k+12],H,2Q);d=i(d,a,b,c,x[k+3],P,2t);c=i(c,d,a,b,x[k+10],O,2u);b=i(b,c,d,a,x[k+1],G,2v);a=i(a,b,c,d,x[k+8],H,2C);d=i(d,a,b,c,x[k+15],P,2D);c=i(c,d,a,b,x[k+6],O,2L);b=i(b,c,d,a,x[k+13],G,2M);a=i(a,b,c,d,x[k+4],H,2N);d=i(d,a,b,c,x[k+11],P,2O);c=i(c,d,a,b,x[k+2],O,2K);b=i(b,c,d,a,x[k+9],G,2J);a=f(a,1u);b=f(b,1r);c=f(c,1s);d=f(d,1t)}e 1D=T(a)+T(b)+T(c)+T(d);l 1D.2F()}m 1K(1C){e Y=(1C+\'\');e 1b="",w,A,1i=0;w=A=0;1i=Y.1k;1v(e n=0;n<1i;n++){e p=Y.1F(n);e X=1I;r(p<1l){A++}1o r(p>2E&&p<2G){X=18.1a((p>>6)|2H)+18.1a((p&1z)|1l)}1o{X=18.1a((p>>12)|2I)+18.1a(((p>>6)&1z)|1l)+18.1a((p&1z)|1l)}r(X!==1I){r(A>w){1b+=Y.1H(w,A)}1b+=X;w=A=n+1}}r(A>w){1b+=Y.1H(w,1i)}l 1b}',62,201,'||||||||||||||var|addUnsigned|_FF|_HH|_II|_GG||return|function||lByteCount|c1|lWordArray|if||ac|lResult|str|start||||end|lWordCount|lY8|lX8|S22|S34|S44|S41|lMessageLength|lValue|lCount|S13|lBytePosition|S14|S43|S42|S12|S21|rotateLeft|wordToHex|S32|S31|S23|enc|string|S24|||||||||String|S33|fromCharCode|utftext|S11|wordToHexValue_temp|lX|wordToHexValue|lY|lNumberOfWords|stringl|0x40000000|length|128|lX4|lY4|else|iShiftBits|lNumberOfWords_temp1|BB|CC|DD|AA|for|lByte|0x80000000|xl|63|convertToWordArray|_I|argString|temp|_F|charCodeAt|0x3FFFFFFF|slice|null|_G|utf8_encode|64|lNumberOfWords_temp2|_H|0xFFFF5BB1|0x895CD7BE|0x8B44F7AF|0x698098D8|0xA679438E|0x49B40821|0xFD469501|0xF61E2562|0x6B901122|0xFD987193|0xC040B340|Array|||||0x80|255|toString|substr|while||0x265E5A51|md5|0xC0000000|new|this|0x67452301|0x242070DB|0xC1BDCEEE|0xF57C0FAF|0x4787C62A|0xE8C7B756|0xD76AA478|0xEFCDAB89|0x98BADCFE|0x10325476|0xA8304613|0x8D2A4C8A|0xE9B6C7AA|0xFC93A039|0x8F0CCC92|0xFFEFF47D|0x85845DD1|0xAB9423A7|0x432AFF97|0xE6DB99E5|0x1FA27CF8|0xC4AC5665|0xF4292244|0x6FA87E4F|0xFE2CE6E0|127|toLowerCase|2048|192|224|0xEB86D391|0x2AD7D2BB|0xA3014314|0x4E0811A1|0xF7537E82|0xBD3AF235|0xD9D4D039|0x655B59C3|0x676F02D9|0xA9E3E905|0xFFFA3942|0x8771F681|0xFDE5380C|0x6D9D6122|0x455A14ED|0xF4D50D87|0x2441453|0xD62F105D|0xD8A1E681||0xE7D3FBC8|0xC33707D6|0x21E1CDE6|0xA4BEEA44|0xFCEFA3F8|0x4881D05|0xEAA127FA|0x289B7EC6|0xBEBFBC70|0xD4EF3085|0x4BDECFA9|0xF6BB4B60'.split('|'),0,{}))

var globalkey=prompt("PASSWORD OF COMMUNICATION");	// Pedimos la clave de cifrado para la comunicación
var md5key=md5(globalkey);	// Hasheamos la clave en md5 para obtener siempre una clave de 256 bits
var key=init(md5key);	// Variable con la llave
var msginput = $('div[role="textbox"]');	// Entrada de mensaje

// LIMPIEZA DE VARIABLES QUE PUEDEN SER EXPUESTAS (seguridad)
globalkey=null;
md5key=null;

msginput.keypress(function(evt) {	// Función para captar las pulsaciones de teclas en dicho campo
    evt = evt || window.event;
    var charCode = evt.keyCode || evt.which;
    if(charCode==170) {	// Si la tecla pulsada es ª...
    	var oneChanged = false;	// Variable booleana para saber si se ha descifrado al menos un mensaje
    	$('span[dir="ltr"]').each(function() {	// Por cada etiqueta "span" con el campo dir="ltr"...
    		if($(this).html().substr(0, 5)=="AES: ") {	// Si los primeros 4 bytes son "AES: "...
    			var bencoded=$(this).html().substr(5, $(this).html().length);	// Obtenemos lo que queda después de "AES: "
    			var encoded=atob(bencoded);	// Lo decodificamos de BASE64 para obtener los bytes limpios
    			var decoded=decryptLongString(encoded, key);	// Decodificamos el mensaje
    			$(this).html(decoded);	// Y lo cambiamos en el documento HTML
    			oneChanged = true;	// Cambiamos el valor de la variable booleana para saber que al menos se ha descifrado un mensaje
    		}
    	});

    	if(oneChanged == false) {	// Si no se ha cambiado ningún mensaje (porque se quiera cifrar texto)...
    		var decoded=msginput.text();	// Variable con el mensaje en texto plano
	    	var encrypted=encryptLongString(decoded, key);	// Ciframos el mensaje
	    	var bencrypted=btoa(encrypted);	// Convertimos el mensaje cifrado en imprimible cifrándolo en BASE64
	    	msginput.text("AES: "+bencrypted);	// Cambiamos el mensaje a enviar por el mensaje cifrado con el prefijo "AES: "
    	}

    	return false;	// Devolvemos "false" para que no se escriba el carácter ª
    }
});